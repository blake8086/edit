<html>
	<head>
		<title></title>
		<style>
			body { margin: 0; padding: 0; }
			#editor {
		        position: absolute;
		        width: 100%;
		        height: 100%;
		    }
		</style>
		<script src="jquery.min.js"></script>
		<script src="json2.js"></script>
	    <script src="ace/build/src/ace.js" type="text/javascript" charset="utf-8"></script>
		<script src="ace/build/src/mode-html.js" type="text/javascript" charset="utf-8"></script>
        <script src="ace/build/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>

		<script>
			$(function() {
		        var editor = ace.edit("editor");
                editor.setShowPrintMargin(false);
                
                var saved = true;

                var hash = window.location.hash;
                if (hash) {
                    filename = hash.replace(/^#/, '');
                } else {
        			filename = window.prompt('Paste filename of file to edit:');
                }
				window.location.hash = filename;
                document.title = filename.replace(/^.+\//, '');
				
				$.get('/file?path=' + filename, function(data) {
					editor.getSession().setValue(data);
                    
                    editor.getSession().on('change', function(e) {
                        console.log(e.data);
                        saved = false;
                        document.title = '*' + filename.replace(/^.+\//, '');
                    });
                    
                    var extension = filename.replace(/^.+\./, '');
        			var extensions = {
                        'html': 'ace/mode/html',
                        'js': 'ace/mode/javascript',
        			};
                    if (extensions[extension]) {
					    var mode = require(extensions[extension]).Mode;
					    editor.getSession().setMode(new mode());
                    }
				});

                editor.commands.addCommand({
                    name: 'save',
                    bindKey: {
                        win: 'Ctrl-S',
                        mac: 'Command-S',
                        sender: 'editor'
                    },
                    exec: function(env, args, request) {
                        console.log('saving...');
    					save();
                    }
                });
				
				function save() {
					$.post('/save', {
						fileName: encodeURIComponent(filename),
						fileContents: editor.getSession().getValue(),
					}, function(data, status, xhr) {});
                    document.title = filename.replace(/^.+\//, '');
				}
                
                window.onbeforeunload = function() {
                    return '';
                };
			});
		</script>
	</head>
	<body>
		<div id="editor"></div>
	</body>
</html>
